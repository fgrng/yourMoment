{% extends "simple_base.html" %}

{% block title %}LLM Providers - yourMoment{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
            <div>
                <h1 class="mb-0"><i class="bi bi-sliders me-2"></i>LLM Providers</h1>
                <p class="text-muted mb-0">Manage API credentials and models used for AI comment generation</p>
            </div>
            <div>
                <a href="/settings/llm-providers/new" class="btn btn-primary">
                    <i class="bi bi-plus-circle me-2"></i>Add Provider
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-4 mb-3">
        <label for="providerFilter" class="form-label">Provider</label>
        <select id="providerFilter" class="form-select">
            <option value="ALL" selected>All Providers</option>
            <option value="openai">OpenAI</option>
            <option value="mistral">Mistral</option>
        </select>
        <div class="form-text">Filter by vendor to focus on a specific integration.</div>
    </div>
    <div class="col-md-4 mb-3">
        <label for="searchInput" class="form-label">Search</label>
        <input type="search" id="searchInput" class="form-control" placeholder="Search by model name or notes">
        <div class="form-text">Search is applied locally to the loaded providers.</div>
    </div>
    <div class="col-md-4 mb-3">
        <label class="form-label">Quick Help</label>
        <div class="border rounded bg-light p-3 small">
            <p class="mb-2"><strong>Tip:</strong> Use separate API keys for production and testing environments.</p>
            <p class="mb-0">Keep your keys private - they are encrypted before storage.</p>
        </div>
    </div>
</div>

<div id="alertContainer" class="mt-3"></div>

<div id="loadingState" class="text-center my-5">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2 text-muted">Loading LLM providers...</p>
</div>

<div id="emptyState" class="text-center my-5" style="display: none;">
    <i class="bi bi-cloud-upload text-muted" style="font-size: 4rem;"></i>
    <h3 class="mt-3">No LLM Providers yet</h3>
    <p class="text-muted">Add your first provider to enable automated comment generation.</p>
    <a href="/settings/llm-providers/new" class="btn btn-primary mt-3">
        <i class="bi bi-plus-circle me-2"></i>Add Provider
    </a>
</div>

<div id="providersList" class="row mt-4" style="display: none;"></div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Import shared utilities
    const { showAlert, escapeHtml, formatDate, formatProviderLabel, fetchOptions, showLoadingState, showEmptyState, showContentState, deleteResource } = window.YM.utils;

    const providerFilter = document.getElementById('providerFilter');
    const searchInput = document.getElementById('searchInput');
    const loadingState = document.getElementById('loadingState');
    const emptyState = document.getElementById('emptyState');
    const providersList = document.getElementById('providersList');

    let providers = [];

    providerFilter.addEventListener('change', () => renderProviders(filterProviders()));
    searchInput.addEventListener('input', () => renderProviders(filterProviders()));

    loadProviders();

    async function loadProviders() {
        showLoadingState(loadingState, [emptyState, providersList]);
        providersList.innerHTML = '';
        showAlert('alertContainer', '', '');

        try {
            const response = await fetch('/api/v1/llm-providers/index', fetchOptions('GET'));

            if (!response.ok) {
                throw new Error(`Failed to load providers: ${response.status}`);
            }

            providers = await response.json();

            if (!providers.length) {
                showEmptyState(emptyState, [loadingState, providersList]);
            } else {
                showContentState(providersList, [loadingState, emptyState]);
                providersList.style.display = 'flex';
                renderProviders(filterProviders());
            }
        } catch (error) {
            console.error('Error loading providers:', error);
            showLoadingState(null, [loadingState, emptyState, providersList]);
            showAlert('alertContainer', 'Unable to load LLM providers. Please try again.', 'danger');
        }
    }

    function filterProviders() {
        const vendor = providerFilter.value;
        const query = searchInput.value.trim().toLowerCase();

        return providers.filter(provider => {
            const matchesVendor = vendor === 'ALL' || provider.provider_name === vendor;
            const haystack = [
                provider.provider_name || '',
                provider.model_name || '',
                (provider.max_tokens || '').toString()
            ].join(' ').toLowerCase();
            const matchesQuery = !query || haystack.includes(query);
            return matchesVendor && matchesQuery;
        });
    }

    function renderProviders(items) {
        providersList.innerHTML = '';

        if (!items.length) {
            providersList.style.display = 'none';
            emptyState.style.display = providers.length ? 'block' : 'none';
            if (providers.length) {
                emptyState.querySelector('h3').textContent = 'No providers match your filter';
                emptyState.querySelector('p').textContent = 'Adjust your filters or search terms to see other providers.';
            } else {
                emptyState.querySelector('h3').textContent = 'No LLM Providers yet';
                emptyState.querySelector('p').textContent = 'Add your first provider to enable automated comment generation.';
            }
            return;
        }

        emptyState.style.display = 'none';
        providersList.style.display = 'flex';

        items.forEach(provider => {
            const col = document.createElement('div');
            col.className = 'col-md-6 col-lg-4 mb-4';

            const providerLabel = formatProviderLabel(provider.provider_name);
            const model = provider.model_name ? escapeHtml(provider.model_name) : '<span class="text-muted">Model not set</span>';
            const tokens = provider.max_tokens ? `${provider.max_tokens} tokens` : 'Default tokens';
            const temperature = provider.temperature !== null && provider.temperature !== undefined
                ? provider.temperature.toFixed(2)
                : 'Default';

            col.innerHTML = `
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-start">
                        <div>
                            <h5 class="mb-1">${providerLabel}</h5>
                            <span class="badge ${provider.is_active ? 'bg-success' : 'bg-secondary'}">
                                ${provider.is_active ? 'Active' : 'Inactive'}
                            </span>
                        </div>
                        <small class="text-muted text-end">${formatDate(provider.created_at)}</small>
                    </div>
                    <div class="card-body">
                        <div class="mb-2">
                            <strong>Model:</strong>
                            <div>${model}</div>
                        </div>
                        <div class="mb-2">
                            <strong>Max tokens:</strong>
                            <div>${tokens}</div>
                        </div>
                        <div class="mb-2">
                            <strong>Temperature:</strong>
                            <div>${temperature}</div>
                        </div>
                        <div class="small text-muted">API keys are encrypted and never displayed after saving.</div>
                    </div>
                    <div class="card-footer bg-transparent">
                        <div class="d-flex gap-2">
                            <a class="btn btn-outline-primary btn-sm flex-grow-1" href="/settings/llm-providers/${provider.id}/edit">
                                <i class="bi bi-pencil"></i> Edit
                            </a>
                            <button class="btn btn-outline-danger btn-sm" type="button" onclick="deleteProvider('${provider.id}')">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            `;

            providersList.appendChild(col);
        });
    }

    window.deleteProvider = async function(providerId) {
        try {
            await deleteResource(
                `/api/v1/llm-providers/${providerId}`,
                'provider configuration',
                () => {
                    showAlert('alertContainer', 'Provider configuration deleted successfully.', 'success');
                    setTimeout(loadProviders, 800);
                }
            );
        } catch (error) {
            showAlert('alertContainer', `Error deleting provider: ${error.message}`, 'danger');
        }
    };
});
</script>
{% endblock %}
