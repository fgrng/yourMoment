{% extends "simple_base.html" %}

{% block title %}{% if provider_id %}LLM-Anbieter bearbeiten{% else %}Neuen LLM-Anbieter verbinden{% endif %} - yourMoment{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
            <div>
                <h1 class="mb-0">
                    <i class="bi bi-robot me-2"></i>
                    {% if provider_id %}LLM-Anbieter bearbeiten{% else %}LLM-Anbieter konfigurieren{% endif %}
                </h1>
                <p class="text-muted mb-0">
                    {% if provider_id %}Aktualisiere die Konfiguration und den API-Schlüssel des LLM-Anbieters{% else %}Füge einen LLM-Anbieter für die automatische KI-Kommentierung hinzu{% endif %}
                </p>
            </div>
            <div>
                <a href="/settings/llm-providers" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-2"></i>Zurück zu den LLM-Anbietern
                </a>
            </div>
        </div>
    </div>
</div>

<div id="loadingState" class="text-center my-5" style="display: {{ 'block' if provider_id else 'none' }};">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Wird geladen …</span>
    </div>
    <p class="mt-2 text-muted">Konfiguration des LLM-Anbieters wird geladen …</p>
</div>

<div class="row mt-4" id="formContainer" style="display: {{ 'none' if provider_id else 'flex' }};">
    <div class="col-lg-8">
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-plug me-2"></i>Konfiguration des LLM-Anbieters</h5>
            </div>
            <div class="card-body">
                <form id="providerForm">
                    <div class="mb-3">
                        <label for="providerName" class="form-label">LLM-Anbieter <span class="text-danger">*</span></label>
                        <select id="providerName" name="provider_name" class="form-select" {{ 'disabled' if provider_id else '' }} required>
                            <option value="">Unterstützte LLM-Anbieter auswählen</option>
                            <option value="openai">OpenAI</option>
                            <option value="mistral">Mistral</option>
                        </select>
                        <div class="form-text">Wähle die LLM-Plattform für diese Konfiguration. Der Anbietertyp kann später nicht geändert werden.</div>
                    </div>

                    <div class="mb-3">
                        <label for="apiKey" class="form-label">API-Schlüssel {% if not provider_id %}<span class="text-danger">*</span>{% endif %}</label>
                        <div class="input-group">
                            <input type="password" id="apiKey" name="api_key" class="form-control" {{ '' if provider_id else 'required' }} placeholder="API-Schlüssel eingeben">
                            <button class="btn btn-outline-secondary" type="button" id="toggleApiKey"><i class="bi bi-eye"></i></button>
                        </div>
                        <div class="form-text">{{ 'Leer lassen, um den aktuellen API-Schlüssel zu behalten' if provider_id else 'Dein API-Schlüssel wird vor der Speicherung verschlüsselt und nach dem Speichern nicht erneut angezeigt.' }}</div>
                    </div>

                    <div class="mb-3">
                        <label for="modelName" class="form-label">Modellname <span class="text-danger">*</span></label>
                        <input type="text" id="modelName" name="model_name" class="form-control" maxlength="100" required placeholder="z. B. gpt-4o-mini oder mistral-large-latest">
                        <div class="form-text">Gib den exakten Modellbezeichner des LLM-Anbieters an.</div>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="maxTokens" class="form-label">Maximale Token</label>
                            <input type="number" id="maxTokens" name="max_tokens" class="form-control" min="1" placeholder="Voreinstellung des LLM-Anbieters verwenden" disabled>
                            <div class="form-text">Optionales Token-Limit für Antworten.</div>
                        </div>
                        <div class="col-md-6">
                            <label for="temperature" class="form-label">Temperatur</label>
                            <div class="input-group">
                                <input type="number" id="temperature" name="temperature" class="form-control" min="0" max="1" step="0.05" placeholder="Voreinstellung des LLM-Anbieters verwenden" disabled>
                                <span class="input-group-text">0.0 - 1.0</span>
                            </div>
                            <div class="form-text">Optionaler Temperaturwert. Niedrige Werte erzeugen fokussierte Antworten, höhere Werte sorgen für mehr Kreativität.</div>
                        </div>
                    </div>

                    <div class="d-flex gap-2 mt-4">
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <i class="bi bi-check-circle me-2"></i>{% if provider_id %}Änderungen speichern{% else %}LLM-Anbieter anlegen{% endif %}
                        </button>
                        <a href="/settings/llm-providers" class="btn btn-outline-secondary">Abbrechen</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Brauchst du Hilfe?</h5>
            </div>
            <div class="card-body small">
                <p>Hisweise zur <strong>Konfiguration von LLM-Anbietern</strong>:</p>
                <ul class="mb-0">
                    <li>Halte API-Schlüssel geheim und rotiere sie regelmäßig.</li>
                    <li>Wähle Modelle passend zu deinem Szenario (Kosten vs. Qualität).</li>
                    <li>Eine geringe Temperatur sorgt für regelkonformere Kommentare.</li>
                    <li>Lass optionale Felder leer, um Voreinstellungen der LLM-Anbieter zu nutzen.</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const providerId = {% if provider_id %}'{{ provider_id | safe }}'{% else %}null{% endif %};
const isEditMode = Boolean(providerId);

document.addEventListener('DOMContentLoaded', async function() {
    // Import shared utilities
    const { fetchOptions, setButtonLoading, resetButton, submitForm, togglePasswordVisibility, safeParseJson, extractErrorMessage } = window.YM.utils;

    const form = document.getElementById('providerForm');
    const providerNameInput = document.getElementById('providerName');
    const apiKeyInput = document.getElementById('apiKey');
    const modelNameInput = document.getElementById('modelName');
    const maxTokensInput = document.getElementById('maxTokens');
    const temperatureInput = document.getElementById('temperature');
    const submitBtn = document.getElementById('submitBtn');
    const toggleApiKeyBtn = document.getElementById('toggleApiKey');
    const toggleApiKeyIcon = toggleApiKeyBtn.querySelector('i');
    const loadingState = document.getElementById('loadingState');
    const formContainer = document.getElementById('formContainer');

    toggleApiKeyBtn.addEventListener('click', () => {
        togglePasswordVisibility(apiKeyInput, toggleApiKeyIcon);
    });

    if (isEditMode) {
        await loadProvider();
    }

    form.addEventListener('submit', async function(event) {
        event.preventDefault();

        const payload = buildPayload();
        if (!payload) {
            return;
        }

        const originalHtml = setButtonLoading(submitBtn, 'Speichern …');
        const url = isEditMode ? `/api/v1/llm-providers/${providerId}` : '/api/v1/llm-providers/create';
        const method = isEditMode ? 'PATCH' : 'POST';

        const success = await submitForm(
            url,
            method,
            payload,
            () => {
                window.showAlert('Konfiguration des LLM-Anbieters wurde erfolgreich gespeichert.', 'success');
                setTimeout(() => {
                    window.location.href = '/settings/llm-providers';
                }, 1000);
            },
            (message) => {
                window.showAlert(message, 'danger');
                resetButton(submitBtn, originalHtml);
            }
        );

        if (!success) {
            resetButton(submitBtn, originalHtml);
        }
    });

    async function loadProvider() {
        try {
            const response = await fetch('/api/v1/llm-providers/index', fetchOptions('GET'));

            if (!response.ok) {
                throw new Error(`Anbieter konnte nicht geladen werden (HTTP ${response.status})`);
            }

            const providers = await response.json();
            const provider = providers.find(item => item.id === providerId);

            if (!provider) {
                window.showAlert('Konfiguration des LLM-Anbieters nicht gefunden oder kein Zugriff.', 'danger');
                loadingState.style.display = 'none';
                return;
            }

            providerNameInput.value = provider.provider_name || '';
            modelNameInput.value = provider.model_name || '';
            maxTokensInput.value = provider.max_tokens ?? '';
            temperatureInput.value = provider.temperature ?? '';

            form.dataset.originalModelName = modelNameInput.value;
            form.dataset.originalMaxTokens = maxTokensInput.value;
            form.dataset.originalTemperature = temperatureInput.value;

            loadingState.style.display = 'none';
            formContainer.style.display = 'flex';
        } catch (error) {
            console.error('Error loading provider configuration:', error);
            window.showAlert('Konfiguration des LLM-Anbieters konnte nicht geladen werden. Bitte später erneut versuchen.', 'danger');
            loadingState.style.display = 'none';
        }
    }

    function buildPayload() {
        const providerName = providerNameInput.value.trim();
        const apiKey = apiKeyInput.value.trim();
        const modelName = modelNameInput.value.trim();
        const maxTokens = maxTokensInput.value.trim();
        const temperature = temperatureInput.value.trim();

        if (!providerName) {
            window.showAlert('Bitte wähle vor dem Speichern einen LLM-Anbieter aus.', 'warning');
            return null;
        }

        if (!isEditMode && !apiKey) {
            window.showAlert('Beim Anlegen eines LLM-Anbieters ist ein API-Schlüssel erforderlich.', 'warning');
            return null;
        }

        if (!modelName) {
            window.showAlert('Der Modellname ist erforderlich.', 'warning');
            return null;
        }

        if (!validateOptionalNumber(maxTokens, 1, null)) {
            return null;
        }
        if (!validateOptionalNumber(temperature, 0, 1)) {
            return null;
        }

        if (!isEditMode) {
            const payload = {
                provider_name: providerName,
                model_name: modelName,
                api_key: apiKey
            };

            if (maxTokens !== '') {
                payload.max_tokens = Number(maxTokens);
            }
            if (temperature !== '') {
                payload.temperature = Number(temperature);
            }

            return payload;
        }

        const diff = {};
        if (apiKey) {
            diff.api_key = apiKey;
        }
        if (modelName !== (form.dataset.originalModelName || '')) {
            diff.model_name = modelName;
        }
        if (maxTokens !== (form.dataset.originalMaxTokens || '')) {
            diff.max_tokens = maxTokens === '' ? null : Number(maxTokens);
        }
        if (temperature !== (form.dataset.originalTemperature || '')) {
            diff.temperature = temperature === '' ? null : Number(temperature);
        }

        if (Object.keys(diff).length === 0) {
            window.showAlert('Keine Änderungen erkannt. Bitte ändere ein Feld, bevor du speicherst.', 'info');
            return null;
        }

        return diff;
    }

    function validateOptionalNumber(value, min, max) {
        if (value === '') {
            return true;
        }
        const parsed = Number(value);
        if (!Number.isFinite(parsed)) {
            window.showAlert('Numerische Felder müssen gültige Zahlen enthalten.', 'warning');
            return false;
        }
        if (min !== null && parsed < min) {
            window.showAlert(`Der Wert muss größer oder gleich ${min} sein.`, 'warning');
            return false;
        }
        if (max !== null && parsed > max) {
            window.showAlert(`Der Wert muss kleiner oder gleich ${max} sein.`, 'warning');
            return false;
        }
        return true;
    }
});
</script>
{% endblock %}
