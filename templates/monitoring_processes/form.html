{% extends "simple_base.html" %}

{% block title %}{% if process_id %}Überwachungsprozess bearbeiten{% else %}Neuer Überwachungsprozess{% endif %} - yourMoment{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
            <div>
                <h1 class="mb-0"><i class="bi bi-activity me-2"></i>{% if process_id %}Überwachungsprozess bearbeiten{% else %}Überwachungsprozess erstellen{% endif %}</h1>
                <p class="text-muted mb-0">{% if process_id %}Passe die automatisierte Artikelüberwachung und KI-Kommentierung an{% else %}Konfiguriere die automatisierte Artikelüberwachung und KI-Kommentierung{% endif %}</p>
            </div>
            <div>
                <a href="/processes" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-2"></i>Zurück zu den Prozessen
                </a>
            </div>
        </div>
    </div>
</div>


<div id="loadingState" class="text-center my-5" style="display: {{ 'block' if process_id else 'none' }};">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Wird geladen …</span>
    </div>
    <p class="mt-2 text-muted">Überwachungsprozess wird geladen …</p>
</div>

<div class="row mt-4" id="formContainer" style="display: {{ 'none' if process_id else 'flex' }};">
    <div class="col-lg-8">
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-sliders me-2"></i>Prozesskonfiguration</h5>
            </div>
            <div class="card-body">
                <form id="processForm">
                    <div class="mb-3">
                        <label for="name" class="form-label">Prozessname <span class="text-danger">*</span></label>
                        <input type="text" id="name" name="name" class="form-control" maxlength="100" required placeholder="z. B. Tech-Artikel-Überwachung">
                        <div class="form-text">Ein eindeutiger Name für diesen Überwachungsprozess (nur für dich sichtbar)</div>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">Beschreibung</label>
                        <textarea id="description" name="description" class="form-control" rows="2" maxlength="500" placeholder="Optionale Hinweise zu diesem Prozess"></textarea>
                        <div class="form-text">Optionale Zusatzinformationen für dich oder dein Team</div>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="maxDuration" class="form-label">Maximale Dauer (Minuten) <span class="text-danger">*</span></label>
                            <input type="number" id="maxDuration" name="max_duration_minutes" class="form-control" min="1" max="1440" required placeholder="60">
                            <div class="form-text">Der Prozess stoppt automatisch, sobald das Limit erreicht ist</div>
                        </div>
                        <div class="col-md-6">
                            <label for="llmProvider" class="form-label">LLM-Anbieter <span class="text-danger">*</span></label>
                            <select id="llmProvider" name="llm_provider_id" class="form-select" required>
                                <option value="">LLM-Anbieter auswählen</option>
                            </select>
                            <div class="form-text">LLM-Anbieter, mit dem die KI-Kommentare erzeugt werden</div>
                        </div>
                    </div>

                    <div class="row g-3 mt-1">
                        <div class="col-md-6">
                            <label for="promptTemplates" class="form-label">Prompt-Vorlagen <span class="text-danger">*</span></label>
                            <select id="promptTemplates" name="prompt_template_ids" class="form-select" size="6" required></select>
                            <div class="form-text">Prompt-Vorlage(n) für die Erstellung der KI-Kommentare</div>
                        </div>
                        <div class="col-md-6">
                            <label for="loginIds" class="form-label">myMoment-Zugangsdaten <span class="text-danger">*</span></label>
                            <select id="loginIds" name="mymoment_login_ids" class="form-select" size="6" required></select>
                            <div class="form-text">myMoment-Zugangsdaten, die zum Posten der KI-Kommentare auf myMoment genutzt werden</div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <label class="form-label">Filter für myMoment Artikel</label>
                        <div class="row g-2">
                            <div class="col-md-4">
                                <label for="tabFilter" class="form-label small">
                                    Tab
                                    <span id="tabLoadingIndicator" class="spinner-border spinner-border-sm ms-2" style="display: none;" role="status">
                                        <span class="visually-hidden">Wird geladen …</span>
                                    </span>
                                </label>
                                <select id="tabFilter" class="form-select" disabled>
                                    <option value="">Wähle Zugangsdaten aus</option>
                                </select>
                                <div class="form-text" id="tabFilterHelp">Wähle myMoment-Zugangsdaten, um verfügbare Klasse zu laden</div>
                            </div>
                            <div class="col-md-4">
                                <label for="categoryFilter" class="form-label small">Kategorie</label>
                                <select id="categoryFilter" class="form-select">
                                    <option value="">Alle Kategorien</option>
                                    <option value="9">Unterhalten</option>
                                    <option value="7">Informieren</option>
                                    <option value="4">Anleiten</option>
                                    <option value="14">Berichten</option>
                                    <option value="5">Erklären</option>
                                    <option value="6">Fragen</option>
                                    <option value="8">Überzeugen</option>
                                    <option value="12">Schreibaufgabe: Schaltplan</option>
                                    <option value="11">Schreibaufgabe: Wegbeschreibung</option>
                                    <option value="10">Schreibaufgabe: Fiktionaler Dialog</option>
                                    <option value="13">Schreibaufgabe: Reisebericht</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="searchFilter" class="form-label small">Suchbegriff</label>
                                <input type="text" id="searchFilter" class="form-control" placeholder="Stichwörter" disabled>
                                <div class="form-text">Optionale Filter, um Artikel mit bestimmten Titeln auf myMoment anzusteuern (derzeit nicht verfügbar)</div>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="generateOnlyCheckbox" checked>
                            <label class="form-check-label" for="generateOnlyCheckbox">
                                <strong>KI-Kommentare nur erzeugen und noch nicht auf myMoment posten</strong>
                            </label>
                            <div class="form-text">
                                Wenn aktiviert, werden KI-Kommentare erzeugt und gespeichert, aber NICHT auf myMoment veröffentlicht.
                                Deaktiviere die Option, um erzeugte Kommentare automatisch unter myMoment-Artikeln zu posten.
                            </div>
                        </div>
                    </div>

                    <hr>

                    <div class="d-flex gap-2 mt-3">
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <i class="bi bi-check-circle me-2"></i>{% if process_id %}Änderungen speichern{% else %}Prozess erstellen{% endif %}
                        </button>
                        <a href="/processes" class="btn btn-outline-secondary">Abbrechen</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Brauchst du Hilfe?</h5>
            </div>
            <div class="card-body small">
                <p> So funktioniert ein <strong>Überwachungsprozess</strong>:
                <ol class="mb-0">
                    <li>Der Prozess überwacht myMoment auf neue Artikel, die deinen Filtern entsprechen.</li>
                    <li>Für jeden neuen Artikel wird pro Prompt-Vorlage und pro myMoment-Zugang eine Anfrage an deinen LLM-Anbieter vorbereitet.</li>
                    <li>Dein LLM-Anbieter erzeugt daraus einen KI-Kommentar.</li>
                    <li>Die Kommentare werden mit den ausgewählten myMoment-Zugangsdaten auf myMoment gepostet.</li>
                    <li>Der Prozess stoppt automatisch, sobald die Maximaldauer erreicht ist.</li>
                </ol>
                <hr>
                <p>Hinweise zu <strong>Sicherheit und Compliance</strong></p>
                <ul class="mb-0">
                    <li>Alle Zugangsdaten werden verschlüsselt gespeichert.</li>
                    <li>Die Laufzeit ist strikt auf die Maximaldauer begrenzt.</li>
                    <li>Du kannst Prozesse jederzeit manuell starten oder stoppen</li>
                    <li> Alle KI-Kommentare erhalten automatisch den Präfix "[Dieser Kommentar stammt von einem KI-ChatBot.]".</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const processId = {% if process_id %}'{{ process_id | safe }}'{% else %}null{% endif %};
const isEditMode = Boolean(processId);

document.addEventListener('DOMContentLoaded', async function() {
    const form = document.getElementById('processForm');
    const nameInput = document.getElementById('name');
    const descriptionInput = document.getElementById('description');
    const maxDurationInput = document.getElementById('maxDuration');
    const providerSelect = document.getElementById('llmProvider');
    const promptSelect = document.getElementById('promptTemplates');
    const loginSelect = document.getElementById('loginIds');
    const categoryFilter = document.getElementById('categoryFilter');
    const tabFilter = document.getElementById('tabFilter');
    const tabLoadingIndicator = document.getElementById('tabLoadingIndicator');
    const tabFilterHelp = document.getElementById('tabFilterHelp');
    const searchFilter = document.getElementById('searchFilter');
    const submitBtn = document.getElementById('submitBtn');
    const loadingState = document.getElementById('loadingState');
    const formContainer = document.getElementById('formContainer');
    const defaultSubmitLabel = submitBtn.innerHTML;

    let currentTabValue = null;
    let loadedTabs = [];

    try {
        await loadSupportingData();
        if (isEditMode) {
            await loadProcess();
        } else {
            formContainer.style.display = 'flex';
        }
    } catch (error) {
        console.error('Initialization error:', error);
        showAlert(error.message || 'Formulardaten konnten nicht geladen werden.', 'danger');
        loadingState.style.display = 'none';
        return;
    }

    // Listen for credential selection changes
    loginSelect.addEventListener('change', async function() {
        const selectedCredentials = Array.from(loginSelect.selectedOptions).map(opt => opt.value);

        if (selectedCredentials.length > 0) {
            // Use the first selected credential to load tabs
            const firstCredentialId = selectedCredentials[0];
            await loadTabsForCredential(firstCredentialId);
        } else {
            // Reset tab selector if no credentials selected
            tabFilter.disabled = true;
            tabFilter.innerHTML = '<option value="">Wähle zuerst Zugangsdaten aus</option>';
            tabFilterHelp.textContent = 'Wähle myMoment-Zugangsdaten, um verfügbare Tabs zu laden';
            currentTabValue = null;
            loadedTabs = [];
        }
    });

    form.addEventListener('submit', async function(event) {
        event.preventDefault();

        const payload = buildPayload();
        if (!payload) {
            return;
        }

        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Wird gespeichert …';

        try {
            const response = await fetch(
                isEditMode ? `/api/v1/monitoring-processes/${processId}` : '/api/v1/monitoring-processes/create',
                {
                    method: isEditMode ? 'PATCH' : 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                }
            );

            if (!response.ok) {
                const error = await safeParseJson(response);
                const message = extractErrorMessage(error) || 'Überwachungsprozess konnte nicht gespeichert werden.';
                showAlert(message, 'danger');
                resetSubmitButton();
                return;
            }

            showAlert('Überwachungsprozess erfolgreich gespeichert.', 'success');
            setTimeout(() => {
                window.location.href = '/processes';
            }, 1000);
        } catch (error) {
            console.error('Save process error:', error);
            showAlert(error.message || 'Unerwarteter Fehler beim Speichern.', 'danger');
            resetSubmitButton();
        }
    });

    async function loadSupportingData() {
        const [providersResp, templatesResp, loginsResp] = await Promise.all([
            fetch('/api/v1/llm-providers/index', fetchOptions()),
            fetch('/api/v1/prompt-templates/index?limit=100', fetchOptions()),
            fetch('/api/v1/mymoment-credentials/index', fetchOptions())
        ]);

        await assertOk(providersResp, 'LLM-Anbieter konnten nicht geladen werden.');
        await assertOk(templatesResp, 'Prompt-Vorlagen konnten nicht geladen werden.');
        await assertOk(loginsResp, 'myMoment-Zugangsdaten konnten nicht geladen werden.');

        const providers = await providersResp.json();
        populateProviderSelect(providers);

        const templates = await templatesResp.json();
        populateMultiSelect(promptSelect, templates, template => ({
            value: template.id,
            label: template.name
        }));

        const logins = await loginsResp.json();
        populateMultiSelect(loginSelect, logins, credential => ({
            value: credential.id,
            label: credential.name || credential.username
        }));
    }

    async function loadProcess() {
        const response = await fetch(`/api/v1/monitoring-processes/${processId}`, fetchOptions());
        await assertOk(response, 'Details zum Überwachungsprozess konnten nicht geladen werden.');
        const process = await response.json();

        nameInput.value = process.name || '';
        descriptionInput.value = process.description || '';
        maxDurationInput.value = process.max_duration_minutes || '';
        providerSelect.value = process.llm_provider_id || '';

        // Parse target_filters
        const filters = process.target_filters || {};
        if (filters.category) {
            categoryFilter.value = filters.category;
        }
        if (filters.search) {
            searchFilter.value = filters.search;
        }

        // Store the tab value to restore after loading tabs
        currentTabValue = filters.tab || null;

        selectValues(promptSelect, process.prompt_template_ids || []);
        selectValues(loginSelect, process.mymoment_login_ids || []);

        // Set generate_only checkbox
        const generateOnlyCheckbox = document.getElementById('generateOnlyCheckbox');
        generateOnlyCheckbox.checked = process.generate_only !== undefined ? process.generate_only : true;

        // Pre-populate tab selector with current value if exists
        if (currentTabValue) {
            tabFilter.innerHTML = `<option value="${currentTabValue}" selected>Aktuell: ${currentTabValue}</option>`;
            tabFilter.disabled = false;
            tabFilterHelp.textContent = 'Verfügbare Tabs werden geladen …';
        }

        // Show form immediately
        loadingState.style.display = 'none';
        formContainer.style.display = 'flex';

        // Load tabs asynchronously in the background (non-blocking)
        const selectedCredentials = process.mymoment_login_ids || [];
        if (selectedCredentials.length > 0) {
            loadTabsForCredential(selectedCredentials[0]).catch(error => {
                console.error('Error loading tabs in background:', error);
                tabFilterHelp.textContent = 'Tabs konnten nicht geladen werden. Du kannst trotzdem mit dem aktuellen Wert speichern.';
            });
        }
    }

    function populateProviderSelect(providers) {
        providerSelect.innerHTML = '<option value="">Anbieter auswählen</option>';
        providers.forEach(provider => {
            const option = document.createElement('option');
            option.value = provider.id;
            option.textContent = `${formatProviderLabel(provider.provider_name)} - ${provider.model_name || 'Kein Modell festgelegt'}`;
            providerSelect.appendChild(option);
        });
    }

    function populateMultiSelect(select, items, mapFn) {
        select.innerHTML = '';
        items.forEach(item => {
            const { value, label } = mapFn(item);
            const option = document.createElement('option');
            option.value = value;
            option.textContent = label;
            select.appendChild(option);
        });
    }

    function selectValues(select, values) {
        const valueSet = new Set(values);
        Array.from(select.options).forEach(option => {
            option.selected = valueSet.has(option.value);
        });
    }

    function buildPayload() {
        const name = nameInput.value.trim();
        const description = descriptionInput.value.trim();
        const maxDuration = maxDurationInput.value.trim();
        const providerId = providerSelect.value;
        const promptIds = Array.from(promptSelect.selectedOptions).map(opt => opt.value);
        const loginIds = Array.from(loginSelect.selectedOptions).map(opt => opt.value);

        if (!name) {
            showAlert('Name ist erforderlich.', 'warning');
            return null;
        }
        if (!maxDuration || Number(maxDuration) < 1) {
            showAlert('Die maximale Dauer muss mindestens 1 Minute betragen.', 'warning');
            return null;
        }
        if (!providerId) {
            showAlert('Bitte einen LLM-Anbieter auswählen.', 'warning');
            return null;
        }
        if (!promptIds.length) {
            showAlert('Bitte mindestens eine Prompt-Vorlage auswählen.', 'warning');
            return null;
        }
        if (!loginIds.length) {
            showAlert('Bitte mindestens einen myMoment-Zugang auswählen.', 'warning');
            return null;
        }

        // Build target filters
        const targetFilters = {};
        const category = categoryFilter.value.trim();
        if (category) {
            targetFilters.category = parseInt(category, 10);
        }
        const tab = tabFilter.value;
        if (tab) {
            targetFilters.tab = tab;
        }
        const search = searchFilter.value.trim();
        if (search) {
            targetFilters.search = search;
        }

        const generateOnly = document.getElementById('generateOnlyCheckbox').checked;

        const payload = {
            name,
            description: description || null,
            max_duration_minutes: Number(maxDuration),
            llm_provider_id: providerId,
            prompt_template_ids: promptIds,
            mymoment_login_ids: loginIds,
            target_filters: targetFilters,
            generate_only: generateOnly
        };

        return payload;
    }

    function fetchOptions() {
        return {
            method: 'GET',
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/json'
            }
        };
    }

    async function assertOk(response, message) {
        if (!response.ok) {
            const errorBody = await safeParseJson(response);
            const detail = extractErrorMessage(errorBody) || `${message} (HTTP ${response.status})`;
            throw new Error(detail);
        }
    }

    async function safeParseJson(response) {
        try {
            return await response.json();
        } catch (error) {
            return null;
        }
    }

    function extractErrorMessage(error) {
        if (!error) {
            return null;
        }
        if (typeof error.detail === 'string') {
            return error.detail;
        }
        if (error.detail && error.detail.message) {
            return error.detail.message;
        }
        if (Array.isArray(error.detail)) {
            return error.detail.map(item => item.msg || item.message).join('\n');
        }
        return error.message || null;
    }

    function showAlert(message, type) {
        window.showAlert(message, type);
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function resetSubmitButton() {
        submitBtn.disabled = false;
        submitBtn.innerHTML = defaultSubmitLabel;
    }

    async function loadTabsForCredential(credentialId) {
        // Show loading indicator (but keep form enabled)
        tabLoadingIndicator.style.display = 'inline-block';
        const previousValue = tabFilter.value || currentTabValue;

        // Keep the current selection visible while loading
        if (previousValue && tabFilter.options.length === 1) {
            // We already have a pre-populated value, just update help text
            tabFilterHelp.textContent = 'Verfügbare Tabs werden geladen …';
        } else {
            tabFilter.disabled = true;
            tabFilter.innerHTML = '<option value="">Tabs werden geladen …</option>';
            tabFilterHelp.textContent = 'Verfügbare Tabs werden von myMoment abgerufen …';
        }

        try {
            const response = await fetch(`/api/v1/mymoment-articles/${credentialId}/tabs`, fetchOptions());

            if (!response.ok) {
                throw new Error(`Tabs konnten nicht geladen werden (HTTP ${response.status})`);
            }

            const data = await response.json();
            loadedTabs = data.items || [];

            // Populate tab selector
            tabFilter.innerHTML = '<option value="">Alle Tabs</option>';
            loadedTabs.forEach(tab => {
                const option = document.createElement('option');
                option.value = tab.id;
                option.textContent = tab.name;
                tabFilter.appendChild(option);
            });

            // Restore previous selection if it exists in the new tabs
            if (previousValue) {
                const tabExists = loadedTabs.some(tab => tab.id === previousValue);
                if (tabExists) {
                    tabFilter.value = previousValue;
                } else if (previousValue) {
                    // Tab no longer available, but preserve it as an option
                    const option = document.createElement('option');
                    option.value = previousValue;
                    option.textContent = `${previousValue} (nicht mehr verfügbar)`;
                    option.selected = true;
                    tabFilter.appendChild(option);
                }
            }

            tabFilter.disabled = false;
            tabFilterHelp.textContent = `${loadedTabs.length} Tab${loadedTabs.length !== 1 ? 's' : ''} verfügbar`;

        } catch (error) {
            console.error('Error loading tabs:', error);

            // If we had a pre-populated value, keep it
            if (previousValue) {
                tabFilter.innerHTML = `<option value="${previousValue}" selected>${previousValue} (Aktualisierung fehlgeschlagen)</option>`;
                tabFilter.disabled = false;
            } else {
                tabFilter.innerHTML = '<option value="">Tabs konnten nicht geladen werden</option>';
            }

            tabFilterHelp.innerHTML = '<span class="text-danger">Tabs konnten nicht geladen werden. Du kannst trotzdem mit dem aktuellen Wert speichern.</span>';
        } finally {
            tabLoadingIndicator.style.display = 'none';
        }
    }

    function formatProviderLabel(providerName) {
        const labels = {
            'openai': 'OpenAI',
            'mistral': 'Mistral'
        };
        return labels[providerName] || providerName || 'Unbekannter Anbieter';
    }
});
</script>
{% endblock %}
