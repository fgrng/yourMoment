{% extends "simple_base.html" %}

{% block title %}{% if credential_id %}myMoment-Zugang bearbeiten{% else %}myMoment-Zugang hinzufügen{% endif %} - yourMoment{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1>
                    <i class="bi bi-person-circle me-2"></i>
                    {% if credential_id %}myMoment-Zugang bearbeiten{% else %}myMoment-Zugang hinzufügen{% endif %}
                </h1>
                <p class="text-muted">
                    {% if credential_id %}Aktualisiere deine myMoment-Zugangsdaten{% else %}Hinterlege deine myMoment-Zugangsdaten für automatisierte Kommentare{% endif %}
                </p>
            </div>
            <div>
                <a href="/settings/mymoment-credentials" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-2"></i>Zurück zu den Zugangsdaten
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Alert Messages -->

<!-- Loading State (for edit mode) -->
<div id="loadingState" class="text-center my-5" style="display: {{ 'block' if credential_id else 'none' }};">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Wird geladen …</span>
    </div>
    <p class="mt-2 text-muted">Kontodetails werden geladen …</p>
</div>

<!-- Form -->
<div class="row mt-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-person-badge me-2"></i>Kontoinformationen</h5>
            </div>
            <div class="card-body">
                <form id="credentialForm">
                    <!-- Name Field -->
                    <div class="mb-3">
                        <label for="name" class="form-label">
                            Kontoname <span class="text-danger">*</span>
                        </label>
                        <input type="text"
                               class="form-control"
                               id="name"
                               name="name"
                               placeholder="z. B. Mein Hauptkonto"
                               required>
                        <div class="form-text">
                            Ein leicht erkennbarer Name für diesen Zugang
                        </div>
                    </div>

                    <!-- Username Field -->
                    <div class="mb-3">
                        <label for="username" class="form-label">
                            myMoment-Benutzername <span class="text-danger">*</span>
                        </label>
                        <input type="username"
                               class="form-control"
                               id="username"
                               name="username"
                               placeholder="ArtificialArmadillo"
                               required>
                        <div class="form-text">
                            Dein Benutzername für myMoment
                        </div>
                    </div>

                    <!-- Password Field -->
                    <div class="mb-3">
                        <label for="password" class="form-label">
                            myMoment-Passwort <span class="text-danger">*</span>
                        </label>
                        <div class="input-group">
                            <input type="password"
                                   class="form-control"
                                   id="password"
                                   name="password"
                                   placeholder="{{ 'Leer lassen, um das aktuelle Passwort zu behalten' if credential_id else 'Passwort eingeben' }}"
                                   {{ '' if credential_id else 'required' }}>
                            <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                                <i class="bi bi-eye" id="togglePasswordIcon"></i>
                            </button>
                        </div>
                        <div class="form-text">
                            {{ 'Leer lassen, um das bestehende Passwort zu behalten' if credential_id else 'Dein myMoment-Passwort (wird vor der Speicherung verschlüsselt)' }}
                        </div>
                    </div>

                    <!-- Active Status -->
                    <div class="mb-3 form-check form-switch">
                        <input type="checkbox"
                               class="form-check-input"
                               id="is_active"
                               name="is_active"
                               checked>
                        <label class="form-check-label" for="is_active">
                            <strong>Aktiv</strong>
                            <div class="form-text">
                                Nur aktive Zugangsdaten können in Überwachungsprozessen verwendet werden
                            </div>
                        </label>
                    </div>

                    <!-- Security Notice -->
                    <div class="alert alert-info">
                        <i class="bi bi-shield-lock me-2"></i>
                        <strong>Sicherheit:</strong> Dein Passwort wird vor der Speicherung mit einem Industriestandard verschlüsselt.
                    </div>

                    <!-- Form Actions -->
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <i class="bi bi-check-circle me-2"></i>
                            {{ 'Konto aktualisieren' if credential_id else 'Konto hinzufügen' }}
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="testBtn">
                            <i class="bi bi-check-circle me-2"></i>Verbindung testen
                        </button>
                <a href="/settings/mymoment-credentials" class="btn btn-outline-secondary">
                            Abbrechen
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Help Sidebar -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-info-circle me-2"></i>Über myMoment-Zugangsdaten</h5>
            </div>
            <div class="card-body">
                <p>myMoment-Zugangsdaten werden genutzt, um:</p>
                <ul>
                    <li>Artikel auf der myMoment-Plattform zu überwachen</li>
                    <li>KI-generierte Kommentare automatisch zu posten</li>
                    <li>Nachzuvollziehen, auf welche Artikel jedes Konto Zugriff hat</li>
                </ul>
                <hr>
                <p><strong>Mehrere Konten:</strong></p>
                <ul>
                    <li>Du kannst mehrere myMoment-Zugänge hinzufügen</li>
                    <li>Jeder Überwachungsprozess kann mehrere Zugangsdaten nutzen</li>
                    <li>Pro Zugang wird ein Kommentar zu neuen Artikeln veröffentlicht</li>
                </ul>
                <hr>
                <p class="mb-0"><strong>Sicherheit:</strong></p>
                <p class="text-muted small">
                    Deine Zugangsdaten werden vor der Speicherung mit Fernet verschlüsselt. Nur du kannst sie nutzen.
                </p>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="bi bi-question-circle me-2"></i>Brauchst du Hilfe?</h5>
            </div>
            <div class="card-body">
                <p class="small">Falls du noch keine myMoment-Zugangsdaten hast:</p>
                <ol class="small">
                    <li>Besuche die myMoment-Plattform</li>
                    <li>Erstelle ein Konto</li>
                    <li>Kehre hierher zurück und hinterlege deine Zugangsdaten</li>
                </ol>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const credentialId = {% if credential_id %}'{{ credential_id | safe }}'{% else %}null{% endif %};
const isEditMode = credentialId !== null;

document.addEventListener('DOMContentLoaded', async function() {
    // Import shared utilities
    const { togglePasswordVisibility, fetchOptions, setButtonLoading, resetButton, submitForm, safeParseJson, extractErrorMessage } = window.YM.utils;

    const form = document.getElementById('credentialForm');
    const submitBtn = document.getElementById('submitBtn');
    const testBtn = document.getElementById('testBtn');
    const togglePassword = document.getElementById('togglePassword');
    const passwordInput = document.getElementById('password');
    const togglePasswordIcon = document.getElementById('togglePasswordIcon');
    const loadingState = document.getElementById('loadingState');

    // Load existing credential in edit mode
    if (isEditMode) {
        try {
            const response = await fetch(`/api/v1/mymoment-credentials/${credentialId}`, fetchOptions('GET'));

            if (!response.ok) {
                throw new Error(`Failed to load credential: ${response.status}`);
            }

            const credential = await response.json();
            loadingState.style.display = 'none';

            // Populate form
            document.getElementById('name').value = credential.name || '';
            document.getElementById('username').value = credential.username || '';
            document.getElementById('is_active').checked = credential.is_active !== false;

            // Password is not returned for security, keep it empty
        } catch (error) {
            console.error('Error loading credential:', error);
            loadingState.style.display = 'none';
            window.showAlert(`Fehler beim Laden der Kontodaten: ${error.message}`, 'danger');
        }
    } else {
        loadingState.style.display = 'none';
    }

    // Toggle password visibility
    togglePassword.addEventListener('click', () => {
        togglePasswordVisibility(passwordInput, togglePasswordIcon);
    });

    // Form submission
    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = {
            name: document.getElementById('name').value,
            username: document.getElementById('username').value,
            is_active: document.getElementById('is_active').checked
        };

        // Only include password if provided
        const password = document.getElementById('password').value;
        if (password) {
            formData.password = password;
        } else if (!isEditMode) {
            window.showAlert('Für neue Zugangsdaten ist ein Passwort erforderlich.', 'danger');
            return;
        }

        const originalHtml = setButtonLoading(submitBtn, 'Speichern …');

        const url = isEditMode
            ? `/api/v1/mymoment-credentials/${credentialId}`
            : '/api/v1/mymoment-credentials/create';
        const method = isEditMode ? 'PUT' : 'POST';

        const success = await submitForm(
            url,
            method,
            formData,
            () => {
                window.showAlert(
                    isEditMode ? 'Konto erfolgreich aktualisiert!' : 'Konto erfolgreich hinzugefügt!',
                    'success'
                );
                setTimeout(() => {
                window.location.href = '/settings/mymoment-credentials';
                }, 1500);
            },
            (message) => {
                window.showAlert(`Fehler: ${message}`, 'danger');
                resetButton(submitBtn, originalHtml);
            }
        );

        if (!success) {
            resetButton(submitBtn, originalHtml);
        }
    });

    // Test connection
    testBtn.addEventListener('click', async function() {
        if (isEditMode) {
            // In edit mode, test the existing saved credentials
            const originalHtml = setButtonLoading(testBtn, 'Verbindung wird getestet…');

            // Show loading alert (auto-hide enabled)
            window.showAlert('🔄 Zugang wird gegen die myMoment-Plattform getestet …', 'info', false);

            try {
                const response = await fetch(`/api/v1/mymoment-credentials/${credentialId}/test`, fetchOptions('POST'));

                if (response.ok) {
                    const result = await response.json();
                    window.showAlert(`✅ Verbindungstest erfolgreich! Angemeldet als ${result.username} auf ${result.platform}.`, 'success');

                    // Update button to show success
                    testBtn.innerHTML = '<i class="bi bi-check-circle-fill"></i> Erfolgreich';
                    testBtn.classList.remove('btn-outline-warning');
                    testBtn.classList.add('btn-success');

                    // Reset after 2 seconds
                    setTimeout(() => {
                        resetButton(testBtn, originalHtml);
                        testBtn.classList.remove('btn-success');
                        testBtn.classList.add('btn-outline-warning');
                    }, 2000);
                } else {
                    const error = await safeParseJson(response);
                    const errorMsg = extractErrorMessage(error) || 'Authentifizierung fehlgeschlagen';
                    window.showAlert(`❌ Verbindungstest fehlgeschlagen: ${errorMsg}`, 'danger');
                    resetButton(testBtn, originalHtml);
                }
            } catch (error) {
                console.error('Error testing connection:', error);
                window.showAlert('❌ Fehler beim Testen der Verbindung. Bitte Netzwerk prüfen und erneut versuchen.', 'danger');
                resetButton(testBtn, originalHtml);
            }
        } else {
            // In create mode, credentials must be saved first before testing
            window.showAlert('⚠️ Bitte speichere die Zugangsdaten zuerst, dann kannst du die Verbindung auf der Bearbeitungsseite testen.', 'warning');
        }

        window.scrollTo({ top: 0, behavior: 'smooth' });
    });
});
</script>
{% endblock %}
