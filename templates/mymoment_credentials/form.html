{% extends "simple_base.html" %}

{% block title %}{{ 'Edit' if credential_id else 'Add' }} myMoment Credential - yourMoment{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1>
                    <i class="bi bi-person-circle me-2"></i>
                    {{ 'Edit' if credential_id else 'Add' }} myMoment Credential
                </h1>
                <p class="text-muted">
                    {{ 'Update your myMoment credentials' if credential_id else 'Add your myMoment credentials for automated commenting' }}
                </p>
            </div>
            <div>
                <a href="/settings/mymoment-credentials" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-2"></i>Back to Credentials
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Alert Messages -->
<div id="alertContainer" class="mt-3"></div>

<!-- Loading State (for edit mode) -->
<div id="loadingState" class="text-center my-5" style="display: {{ 'block' if credential_id else 'none' }};">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2 text-muted">Loading account details...</p>
</div>

<!-- Form -->
<div class="row mt-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-person-badge me-2"></i>Account Information</h5>
            </div>
            <div class="card-body">
                <form id="credentialForm">
                    <!-- Name Field -->
                    <div class="mb-3">
                        <label for="name" class="form-label">
                            Account Name <span class="text-danger">*</span>
                        </label>
                        <input type="text"
                               class="form-control"
                               id="name"
                               name="name"
                               placeholder="e.g., My Primary Account"
                               required>
                        <div class="form-text">
                            A friendly name to identify this account
                        </div>
                    </div>

                    <!-- Username Field -->
                    <div class="mb-3">
                        <label for="username" class="form-label">
                            myMoment Username <span class="text-danger">*</span>
                        </label>
                        <input type="username"
                               class="form-control"
                               id="username"
                               name="username"
                               placeholder="ArtificialArmadillo"
                               required>
                        <div class="form-text">
                            Your myMoment credential username
                        </div>
                    </div>

                    <!-- Password Field -->
                    <div class="mb-3">
                        <label for="password" class="form-label">
                            myMoment Password <span class="text-danger">*</span>
                        </label>
                        <div class="input-group">
                            <input type="password"
                                   class="form-control"
                                   id="password"
                                   name="password"
                                   placeholder="{{ 'Leave empty to keep current password' if credential_id else 'Enter your password' }}"
                                   {{ '' if credential_id else 'required' }}>
                            <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                                <i class="bi bi-eye" id="togglePasswordIcon"></i>
                            </button>
                        </div>
                        <div class="form-text">
                            {{ 'Leave empty to keep the existing password' if credential_id else 'Your myMoment credential password (encrypted before storage)' }}
                        </div>
                    </div>

                    <!-- Active Status -->
                    <div class="mb-3 form-check form-switch">
                        <input type="checkbox"
                               class="form-check-input"
                               id="is_active"
                               name="is_active"
                               checked>
                        <label class="form-check-label" for="is_active">
                            <strong>Active</strong>
                            <div class="form-text">
                                Only active credentials can be used in monitoring processes
                            </div>
                        </label>
                    </div>

                    <!-- Security Notice -->
                    <div class="alert alert-info">
                        <i class="bi bi-shield-lock me-2"></i>
                        <strong>Security:</strong> Your password will be encrypted using industry-standard encryption before being stored in the database.
                    </div>

                    <!-- Form Actions -->
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <i class="bi bi-check-circle me-2"></i>
                            {{ 'Update Account' if credential_id else 'Add Account' }}
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="testBtn">
                            <i class="bi bi-check-circle me-2"></i>Test Connection
                        </button>
                <a href="/settings/mymoment-credentials" class="btn btn-outline-secondary">
                            Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Help Sidebar -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-info-circle me-2"></i>About myMoment Credentials</h5>
            </div>
            <div class="card-body">
                <p>myMoment credentials are used to:</p>
                <ul>
                    <li>Monitor articles on myMoment platform</li>
                    <li>Automatically post AI-generated comments</li>
                    <li>Track which articles each account has access to</li>
                </ul>
                <hr>
                <p><strong>Multiple Accounts:</strong></p>
                <ul>
                    <li>You can add multiple myMoment credentials</li>
                    <li>Each monitoring process can use multiple credentials</li>
                    <li>One comment per credential will be posted to new articles</li>
                </ul>
                <hr>
                <p class="mb-0"><strong>Security:</strong></p>
                <p class="text-muted small">
                    Your credentials are encrypted using Fernet encryption before being stored. Only you can use them.
                </p>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="bi bi-question-circle me-2"></i>Need Help?</h5>
            </div>
            <div class="card-body">
                <p class="small">If you don't have myMoment credentials yet:</p>
                <ol class="small">
                    <li>Visit the myMoment platform</li>
                    <li>Create an account</li>
                    <li>Return here to add your credentials</li>
                </ol>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const credentialId = {% if credential_id %}'{{ credential_id | safe }}'{% else %}null{% endif %};
const isEditMode = credentialId !== null;

document.addEventListener('DOMContentLoaded', async function() {
    // Import shared utilities
    const { showAlert, togglePasswordVisibility, fetchOptions, setButtonLoading, resetButton, submitForm, safeParseJson, extractErrorMessage } = window.YM.utils;

    const form = document.getElementById('credentialForm');
    const submitBtn = document.getElementById('submitBtn');
    const testBtn = document.getElementById('testBtn');
    const togglePassword = document.getElementById('togglePassword');
    const passwordInput = document.getElementById('password');
    const togglePasswordIcon = document.getElementById('togglePasswordIcon');
    const loadingState = document.getElementById('loadingState');

    // Load existing credential in edit mode
    if (isEditMode) {
        try {
            const response = await fetch(`/api/v1/mymoment-credentials/${credentialId}`, fetchOptions('GET'));

            if (!response.ok) {
                throw new Error(`Failed to load credential: ${response.status}`);
            }

            const credential = await response.json();
            loadingState.style.display = 'none';

            // Populate form
            document.getElementById('name').value = credential.name || '';
            document.getElementById('username').value = credential.username || '';
            document.getElementById('is_active').checked = credential.is_active !== false;

            // Password is not returned for security, keep it empty
        } catch (error) {
            console.error('Error loading credential:', error);
            loadingState.style.display = 'none';
            showAlert('alertContainer', `Error loading account details: ${error.message}`, 'danger');
        }
    } else {
        loadingState.style.display = 'none';
    }

    // Toggle password visibility
    togglePassword.addEventListener('click', () => {
        togglePasswordVisibility(passwordInput, togglePasswordIcon);
    });

    // Form submission
    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = {
            name: document.getElementById('name').value,
            username: document.getElementById('username').value,
            is_active: document.getElementById('is_active').checked
        };

        // Only include password if provided
        const password = document.getElementById('password').value;
        if (password) {
            formData.password = password;
        } else if (!isEditMode) {
            showAlert('alertContainer', 'Password is required for new credentials', 'danger');
            return;
        }

        const originalHtml = setButtonLoading(submitBtn, 'Saving...');

        const url = isEditMode
            ? `/api/v1/mymoment-credentials/${credentialId}`
            : '/api/v1/mymoment-credentials/create';
        const method = isEditMode ? 'PUT' : 'POST';

        const success = await submitForm(
            url,
            method,
            formData,
            () => {
                showAlert(
                    'alertContainer',
                    isEditMode ? 'Account updated successfully!' : 'Account added successfully!',
                    'success'
                );
                setTimeout(() => {
                window.location.href = '/settings/mymoment-credentials';
                }, 1500);
            },
            (message) => {
                showAlert('alertContainer', `Error: ${message}`, 'danger');
                resetButton(submitBtn, originalHtml);
            }
        );

        if (!success) {
            resetButton(submitBtn, originalHtml);
        }
    });

    // Test connection
    testBtn.addEventListener('click', async function() {
        if (isEditMode) {
            // In edit mode, test the existing saved credentials
            const originalHtml = setButtonLoading(testBtn, 'Testing connection...');

            try {
                const response = await fetch(`/api/v1/mymoment-credentials/${credentialId}/test`, fetchOptions('POST'));

                if (response.ok) {
                    const result = await response.json();
                    showAlert('alertContainer', `✅ Connection test successful! Authenticated as ${result.username} on ${result.platform}.`, 'success');
                } else {
                    const error = await safeParseJson(response);
                    const errorMsg = extractErrorMessage(error) || 'Authentication failed';
                    showAlert('alertContainer', `❌ Connection test failed: ${errorMsg}`, 'danger');
                }
            } catch (error) {
                console.error('Error testing connection:', error);
                showAlert('alertContainer', '❌ Error testing connection. Please check your network and try again.', 'danger');
            } finally {
                resetButton(testBtn, originalHtml);
            }
        } else {
            // In create mode, credentials must be saved first before testing
            showAlert('alertContainer', '⚠️ Please save the credentials first, then you can test the connection from the edit page.', 'warning');
        }

        window.scrollTo({ top: 0, behavior: 'smooth' });
    });
});
</script>
{% endblock %}
